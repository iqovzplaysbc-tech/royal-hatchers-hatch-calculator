<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Royal Hatchers Luck Calculator</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0f0f14;color:#eaeaea;padding:18px;}
    .wrap{max-width:900px;margin:0 auto;}
    h1{font-size:20px;margin:0 0 12px 0;}
    .card{background:#171722;border:1px solid #2a2a3a;border-radius:10px;padding:12px;margin:12px 0;}
    .row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    .row2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media(max-width:820px){.row{grid-template-columns:repeat(2,minmax(0,1fr));}}
    label{font-size:12px;color:#bdbdd1;display:block;margin-bottom:4px;}
    input,select{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #2a2a3a;background:#0f0f14;color:#eaeaea;}
    button{padding:9px 12px;border-radius:9px;border:0;cursor:pointer;background:#2c6cff;color:#fff;font-weight:bold;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{background:#232336;border:1px solid #2a2a3a;color:#eaeaea;padding:8px 10px;border-radius:999px;cursor:pointer;font-size:13px;}
    .tab.active{background:#2c6cff;border-color:#2c6cff;}
    .muted{color:#bdbdd1;font-size:12px;}
    pre{white-space:pre-wrap;background:#0b0b10;border:1px solid #2a2a3a;border-radius:10px;padding:10px;margin:10px 0 0 0;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2a3a;background:#0f0f14;margin-left:6px;color:#bdbdd1}
    .tier{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a2a3a;background:#0f0f14;color:#bdbdd1}
    .tier.Royal{border-color:#7d3cff;color:#cbb7ff}
    .tier.Secret{border-color:#ff4d7a;color:#ffb3c7}
    .tier.Legendary{border-color:#f7c942;color:#ffe7a0}
    .tier.Epic{border-color:#7ad7ff;color:#bfeeff}
    .tier.Rare{border-color:#72ff98;color:#bfffd0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Royal Hatchers Hatch Calculator <span class="pill">v1.1</span></h1>
  <div class="muted">Tip: Use your in-game Debug values for the most accurate results (Luck %, Hatch Time, Egg Hatches).</div>

  <!-- STATS -->
  <div class="card">
    <div class="row">
      <div>
        <label>Luck % (Debug) üçÄ</label>
        <input id="luckPercent" type="number" value="0" min="0" step="1" placeholder="Example: 1678" />
        <div class="muted" id="luckMulText"></div>
      </div>
      <div>
        <label>Hatch Time (seconds) (Debug) ‚è±Ô∏è</label>
        <input id="hatchTimeSec" type="number" value="1" min="0.01" step="0.01" placeholder="Example: 0.9" />
      </div>
      <div>
        <label>Egg Hatches per Batch (Debug) ü•ö</label>
        <input id="eggsPerCycle" type="number" value="1" min="1" step="1" placeholder="Example: 10" />
      </div>
      <div>
        <label>Shiny Multiplier ‚ú®</label>
        <input id="shinyMult" type="number" value="100" min="1" step="1" />
        <div class="muted">You said 1/3,000,000 ‚Üí 1/300,000,000 (√ó100)</div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="single">Single Pet</div>
    <div class="tab" data-tab="eggs">Egg Odds</div>
    <div class="tab" data-tab="sim">Simulator</div>
  </div>

  <!-- SINGLE -->
  <div class="card" id="single">
    <div class="row2">
      <div>
        <label>Pick a pet (from any egg)</label>
        <select id="singlePetSelect"></select>
        <div class="muted" id="singlePetMeta"></div>
      </div>
      <div>
        <label>Or enter Base Odds (1/x or %)</label>
        <input id="baseOddsInput" placeholder='Examples: 1/3000000  |  0.01%  |  3.69%' />
        <div class="muted">If you type here, it overrides the dropdown‚Äôs odds.</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Also compute shiny?</label>
        <select id="wantShiny">
          <option value="no">No</option>
          <option value="yes">Yes (same pet, shiny)</option>
        </select>
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button id="calcSingleBtn">Calculate</button>
        <button id="copySingleBtn">Copy</button>
      </div>
    </div>

    <pre id="singleOut">Pick a pet (or enter odds), then Calculate.</pre>
  </div>

  <!-- EGGS -->
  <div class="card" id="eggs" style="display:none;">
    <div class="row2">
      <div>
        <label>Egg</label>
        <select id="eggSelect"></select>
        <div class="muted" id="eggMeta"></div>
      </div>
      <div>
        <label>Filter tier</label>
        <select id="tierFilter">
          <!-- default is Legendary+ -->
          <option value="Legendary+">Legendary+</option>
          <option value="">All</option>
          <option value="Epic+">Epic+</option>
          <option value="Legendary">Legendary</option>
          <option value="Secret+">Secret+</option>
          <option value="Royal">Royal only</option>
          <option value="Secret">Secret only</option>
          <option value="Epic">Epic only</option>
          <option value="Rare">Rare only</option>
          <option value="Common">Common only</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="renderEggBtn">Show Egg Odds</button>
      <button id="copyEggBtn">Copy</button>
    </div>

    <pre id="eggOut">Select an egg, then ‚ÄúShow Egg Odds‚Äù.</pre>
  </div>

  <!-- SIM -->
  <div class="card" id="sim" style="display:none;">
    <div class="row">
      <div>
        <label>Egg</label>
        <select id="simEggSelect"></select>
      </div>
      <div>
        <label>Batches to simulate</label>
        <input id="simCycles" type="number" min="1" step="1" value="5000"/>
        <div class="muted">Each batch opens (Egg Hatches) eggs.</div>
      </div>
      <div>
        <label>Stop early if hit (optional)</label>
        <select id="simStopPet">
          <option value="">No early stop</option>
        </select>
      </div>
      <div>
        <label>Stop condition</label>
        <select id="simStopMode">
          <option value="any">Get at least 1</option>
          <option value="shiny">Get shiny (uses shiny multiplier)</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="simBtn">Run Simulation</button>
      <button id="copySimBtn">Copy</button>
    </div>

    <pre id="simOut">Simulation uses: one result per egg hatch, weighted by your egg odds.\nLuck affects the ‚Äú1/x‚Äù pets (Legendary/Secret/Royal) by dividing their denominators.</pre>
  </div>

  <div class="muted" style="margin-top:14px;">
  </div>
</div>

<script>
(() => {
  // ========= Data =========
  const EGGS = [
    {
      name: "Common Egg",
      cost: 50,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Doggy", tier: "Common", type: "percent", value: 50 },
        { name: "Kitty", tier: "Common", type: "percent", value: 35 },
        { name: "Bunny", tier: "Rare", type: "percent", value: 15 },
        { name: "Bear", tier: "Epic", type: "percent", value: 4.9 },
        { name: "King Kitty", tier: "Royal", type: "odds", value: 19999999 }
      ]
    },
    {
      name: "Spotted Egg",
      cost: 300,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Mouse", tier: "Common", type: "percent", value: 55 },
        { name: "Deer", tier: "Common", type: "percent", value: 30 },
        { name: "Fox", tier: "Rare", type: "percent", value: 11 },
        { name: "Bee", tier: "Epic", type: "percent", value: 4 }
      ]
    },
    {
      name: "Rocky Egg",
      cost: 1000,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Rocky Doggy", tier: "Common", type: "percent", value: 30 },
        { name: "Rocky Kitty", tier: "Common", type: "percent", value: 25 },
        { name: "Rocky Fox", tier: "Rare", type: "percent", value: 20 },
        { name: "Rocky Dinosaur", tier: "Rare", type: "percent", value: 15 },
        { name: "Rocky Golem", tier: "Rare", type: "percent", value: 7 },
        { name: "Rocky Dragon", tier: "Epic", type: "percent", value: 3 }
      ]
    },
    {
      name: "Mushroom Egg",
      cost: 2500,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Mushroom Doggy", tier: "Common", type: "percent", value: 55 },
        { name: "Mushroom Kitty", tier: "Common", type: "percent", value: 30 },
        { name: "Mushroom Bunny", tier: "Rare", type: "percent", value: 11 },
        { name: "Mushroom Fox", tier: "Epic", type: "percent", value: 3.69 },
        { name: "Majestic Mushy", tier: "Legendary", type: "odds", value: 333 },
        { name: "King Mushy", tier: "Secret", type: "odds", value: 3000000 }
      ]
    },
    {
      name: "Leaf Egg",
      cost: 5000,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Leaf Doggy", tier: "Common", type: "percent", value: 55 },
        { name: "Leaf Kitty", tier: "Common", type: "percent", value: 30 },
        { name: "Leaf Bunny", tier: "Rare", type: "percent", value: 11 },
        { name: "Squirrel", tier: "Epic", type: "percent", value: 3.69 },
        { name: "Angelic Pumpkin", tier: "Legendary", type: "odds", value: 571 },
        { name: "Elegant Leaf", tier: "Secret", type: "odds", value: 3000000 }
      ]
    },
    {
      name: "Arctic Egg",
      cost: 12500,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Arctic Doggy", tier: "Common", type: "percent", value: 55 },
        { name: "Arctic Golem", tier: "Common", type: "percent", value: 30 },
        { name: "Arctic Bear", tier: "Rare", type: "percent", value: 11 },
        { name: "Arctic Dragon", tier: "Epic", type: "percent", value: 3.69 },
        { name: "Mammoth", tier: "Legendary", type: "odds", value: 500 },
        { name: "Yeti", tier: "Secret", type: "odds", value: 3000000 }
      ]
    },
    {
      name: "Icy Egg",
      cost: 20000,
      currency: "coins",
      enabled: true,
      pets: [
        { name: "Icy Bear", tier: "Common", type: "percent", value: 55 },
        { name: "Icy Fox", tier: "Common", type: "percent", value: 30 },
        { name: "Icy Deer", tier: "Rare", type: "percent", value: 11 },
        { name: "Icy Dinosaur", tier: "Epic", type: "percent", value: 3.69 },
        { name: "Icy Blast", tier: "Legendary", type: "odds", value: 2000 },
        { name: "Frost Overlord", tier: "Legendary", type: "odds", value: 20000 },
        { name: "Frost Fiend", tier: "Secret", type: "odds", value: 3500000 }
      ]
    },
    {
      name: "Release Egg (Legacy)",
      cost: 2000,
      currency: "coins",
      enabled: false,
      pets: [
        { name: "Release Doggy", tier: "Common", type: "percent", value: 50 },
        { name: "Release Fox", tier: "Common", type: "percent", value: 40 },
        { name: "Release Dragon", tier: "Epic", type: "percent", value: 10 },
        { name: "Release Serpent", tier: "Legendary", type: "odds", value: 1000 },
        { name: "Release Overlord", tier: "Legendary", type: "odds", value: 13333 },
        { name: "Release Hexarium", tier: "Legendary", type: "odds", value: 80000 },
        { name: "Toxic Overseer", tier: "Secret", type: "odds", value: 3000000 },
        { name: "Midnight Pyramidium", tier: "Royal", type: "odds", value: 19999999 }
      ]
    },
    {
      name: "Lovely Egg",
      cost: 100,
      currency: "hearts",
      enabled: true,
      pets: [
        { name: "Lovely Doggy", tier: "Common", type: "percent", value: 50 },
        { name: "Lovely Kitty", tier: "Rare", type: "percent", value: 40 },
        { name: "Lovely Bunny", tier: "Epic", type: "percent", value: 10 },
        { name: "Lovestruck Dragon", tier: "Legendary", type: "odds", value: 400 },
        { name: "Lovestruck Star", tier: "Secret", type: "odds", value: 2000000 }
      ]
    },
    {
      name: "Valentines Egg",
      cost: 500,
      currency: "hearts",
      enabled: true,
      pets: [
        { name: "Valentines Mouse", tier: "Common", type: "percent", value: 70 },
        { name: "Valentines Fox", tier: "Rare", type: "percent", value: 25 },
        { name: "Winged Heart", tier: "Epic", type: "percent", value: 4 },
        { name: "Lovely Blast", tier: "Legendary", type: "odds", value: 1333 },
        { name: "Lovely Teddy Bear", tier: "Legendary", type: "odds", value: 20000 },
        { name: "Cupid", tier: "Legendary", type: "odds", value: 111111 },
        { name: "Heavenly Rose", tier: "Secret", type: "odds", value: 4999999 },
        { name: "Lovely Harp", tier: "Secret", type: "odds", value: 12500000 },
        { name: "Loyal Heart", tier: "Royal", type: "odds", value: 30000000 }
      ]
    },
    {
      name: "Secret Bounty",
      cost: 0,
      currency: "special",
      enabled: true,
      pets: [
        { name: "Prisma Shard", tier: "Secret", type: "odds", value: 12500000 }
      ]
    }
  ];

  // ========= Helpers =========
  const fmtInt = (n) => Math.round(n).toLocaleString();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function luckMultiplierFromPercent(luckPercent){
    const lp = Number(luckPercent);
    if (!isFinite(lp) || lp < 0) return 1;
    return 1 + (lp/100);
  }

  function parseOddsInputToProb(s){
    if (!s) return null;
    let t = String(s).trim().toLowerCase().replace(/,/g,'');
    if (!t) return null;

    if (t.includes('/')) {
      const parts = t.split('/');
      const denom = Number(parts[1]);
      if (isFinite(denom) && denom > 0) return 1/denom;
      return null;
    }

    if (t.endsWith('%')) {
      const p = Number(t.slice(0,-1));
      if (isFinite(p) && p > 0) return p/100;
      return null;
    }

    const v = Number(t);
    if (isFinite(v) && v > 0 && v <= 1) return v;
    if (isFinite(v) && v > 1) return 1/v;
    return null;
  }

  function petBaseProb(pet){
    if (pet.type === "percent") return pet.value / 100;
    if (pet.type === "odds") return 1 / pet.value;
    return 0;
  }

  function petEffectiveProb(pet, luckMult){
    // Luck only applies to 1/x entries (Legendary/Secret/Royal style pets)
    if (pet.type === "odds") {
      const effDen = pet.value / luckMult;
      return 1 / effDen;
    }
    return petBaseProb(pet);
  }

  function eggProbabilityTable(egg, luckMult){
    const items = egg.pets.map(p => {
      const raw = petEffectiveProb(p, luckMult);
      return { ...p, rawProb: raw };
    });
    const total = items.reduce((a,b)=>a + (b.rawProb||0), 0);
    const safeTotal = total > 0 ? total : 1;
    return items.map(it => ({...it, prob: (it.rawProb||0)/safeTotal}));
  }

  function sampleFromTable(table){
    const r = Math.random();
    let acc = 0;
    for (const it of table){
      acc += it.prob;
      if (r <= acc) return it;
    }
    return table[table.length-1];
  }

  function timePretty(sec){
    if (!isFinite(sec) || sec < 0) return "N/A";
    if (sec < 60) return `${sec.toFixed(2)}s`;
    const min = sec/60;
    if (min < 60) return `${min.toFixed(2)}m`;
    const hr = min/60;
    if (hr < 24) return `${hr.toFixed(2)}h`;
    const day = hr/24;
    return `${day.toFixed(2)}d`;
  }

  function pctPretty(p){
    // p is probability (0..1). return a clean percent string.
    const pct = p * 100;
    if (pct >= 10) return `${pct.toFixed(2)}%`;
    if (pct >= 1) return `${pct.toFixed(3)}%`;
    if (pct >= 0.1) return `${pct.toFixed(4)}%`;
    if (pct >= 0.01) return `${pct.toFixed(5)}%`;
    return `${pct.toFixed(6)}%`;
  }

  function tierAtLeast(tier, minTier){
    const order = ["Common","Rare","Epic","Legendary","Secret","Royal"];
    const a = order.indexOf(tier);
    const b = order.indexOf(minTier);
    if (a === -1 || b === -1) return false;
    return a >= b;
  }

  function passesTierFilter(tier, filter){
    if (!filter) return true;
    if (filter === "Legendary+") return tierAtLeast(tier, "Legendary");
    if (filter === "Epic+") return tierAtLeast(tier, "Epic");
    if (filter === "Secret+") return tierAtLeast(tier, "Secret");
    if (filter === "Royal") return tier === "Royal";
    if (filter === "Secret") return tier === "Secret";
    if (filter === "Legendary") return tier === "Legendary";
    if (filter === "Epic") return tier === "Epic";
    if (filter === "Rare") return tier === "Rare";
    if (filter === "Common") return tier === "Common";
    return true;
  }

  // ========= UI =========
  const el = (id) => document.getElementById(id);

  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const tab = t.dataset.tab;
      el("single").style.display = tab === "single" ? "" : "none";
      el("eggs").style.display = tab === "eggs" ? "" : "none";
      el("sim").style.display = tab === "sim" ? "" : "none";
    }));

    const eggSelect = el("eggSelect");
    const simEggSelect = el("simEggSelect");
    const enabledEggs = EGGS.filter(e => e.enabled);

    for (const e of enabledEggs){
      const opt1 = document.createElement("option");
      opt1.value = e.name;
      opt1.textContent = `${e.name}`;
      eggSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = e.name;
      opt2.textContent = `${e.name}`;
      simEggSelect.appendChild(opt2);
    }

    const allPets = [];
    for (const egg of enabledEggs){
      for (const p of egg.pets){
        allPets.push({ egg: egg.name, cost: egg.cost, currency: egg.currency, ...p });
      }
    }

    const singlePetSelect = el("singlePetSelect");
    allPets.forEach((p, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${p.name} (${p.egg})`;
      singlePetSelect.appendChild(opt);
    });

    const simStopPet = el("simStopPet");
    function refreshSimStopPet(){
      const eggName = simEggSelect.value;
      const egg = enabledEggs.find(e => e.name === eggName);
      simStopPet.innerHTML = `<option value="">No early stop</option>`;
      if (!egg) return;
      egg.pets.forEach(p => {
        const o = document.createElement("option");
        o.value = p.name;
        o.textContent = `${p.name} (${p.tier})`;
        simStopPet.appendChild(o);
      });
    }
    simEggSelect.addEventListener("change", refreshSimStopPet);
    refreshSimStopPet();

    const updateLuckText = () => {
      const mul = luckMultiplierFromPercent(el("luckPercent").value);
      el("luckMulText").textContent = `Multiplier: ${mul.toFixed(2)}√ó`;
    };
    el("luckPercent").addEventListener("input", updateLuckText);
    updateLuckText();

    const updateSingleMeta = () => {
      const idx = Number(singlePetSelect.value);
      const p = allPets[idx];
      if (!p) { el("singlePetMeta").textContent = ""; return; }
      const baseStr = p.type === "percent"
        ? `${p.value}%`
        : `1/${p.value.toLocaleString()}`;
      el("singlePetMeta").innerHTML =
        `Egg: <b>${p.egg}</b> ‚Ä¢ Tier: <span class="tier ${p.tier}">${p.tier}</span> ‚Ä¢ Base: <b>${baseStr}</b>`;
    };
    singlePetSelect.addEventListener("change", updateSingleMeta);
    updateSingleMeta();

    const updateEggMeta = () => {
      const egg = enabledEggs.find(e => e.name === eggSelect.value);
      if (!egg) { el("eggMeta").textContent = ""; return; }
      const costStr = egg.currency === "coins" ? `${egg.cost.toLocaleString()} coins`
                    : egg.currency === "hearts" ? `${egg.cost.toLocaleString()} hearts`
                    : egg.currency;
      el("eggMeta").textContent = `Cost: ${costStr}`;
    };
    eggSelect.addEventListener("change", updateEggMeta);
    updateEggMeta();

    // ===== Single calc (simplified output, no 50/90/99 stuff) =====
    el("calcSingleBtn").addEventListener("click", () => {
      const luckMult = luckMultiplierFromPercent(el("luckPercent").value);
      const hatchTime = Number(el("hatchTimeSec").value);
      const eggsPer = Math.max(1, Math.floor(Number(el("eggsPerCycle").value || 1)));
      const shinyMult = Math.max(1, Number(el("shinyMult").value || 100));

      const overrideProb = parseOddsInputToProb(el("baseOddsInput").value);

      // Helper: chance per batch and avg batches
      const calcBatchStats = (perEggProb) => {
        const perBatchChance = 1 - Math.pow(1 - perEggProb, eggsPer);
        const avgBatches = perBatchChance > 0 ? (1 / perBatchChance) : Infinity;
        const avgTime = avgBatches * hatchTime;
        return { perBatchChance, avgBatches, avgTime };
      };

      // Custom input overrides
      if (overrideProb) {
        // Treat overrideProb as base probability (per egg) BEFORE luck. Apply luck only if the user entered a denominator-like value.
        // To keep it simple: we interpret override as base odds, and if it's small (most are), we apply luck via denom scaling.
        const approxDen = 1 / overrideProb;
        const effDen = approxDen / luckMult;
        const perEggProb = 1 / effDen;

        const { perBatchChance, avgBatches, avgTime } = calcBatchStats(perEggProb);

        let out =
`Custom Odds
Effective Odds: 1/${fmtInt(effDen)}
Chance per batch: ${pctPretty(perBatchChance)}
Avg batches: ~${isFinite(avgBatches) ? fmtInt(avgBatches) : "‚àû"}
Avg time: ~${timePretty(avgTime)}
`;
        if (el("wantShiny").value === "yes") {
          const effDenShiny = effDen * shinyMult;
          const perEggProbShiny = 1 / effDenShiny;
          const shinyStats = calcBatchStats(perEggProbShiny);
          out +=
`\nShiny (√ó${shinyMult})
Shiny Odds: 1/${fmtInt(effDenShiny)}
Shiny chance per batch: ${pctPretty(shinyStats.perBatchChance)}
Avg shiny batches: ~${isFinite(shinyStats.avgBatches) ? fmtInt(shinyStats.avgBatches) : "‚àû"}
Avg shiny time: ~${timePretty(shinyStats.avgTime)}
`;
        }

        el("singleOut").textContent = out;
        return;
      }

      // From dropdown
      const idx = Number(singlePetSelect.value);
      const p = allPets[idx];
      if (!p) { el("singleOut").textContent = "Pick a pet first."; return; }

      // Percent pets: keep simple and do not apply luck in v1
      if (p.type === "percent") {
        const perEggProb = p.value / 100;
        const { perBatchChance, avgBatches, avgTime } = calcBatchStats(perEggProb);

        let out =
`${p.name} [${p.tier}]
Egg: ${p.egg}
Odds: ${p.value}%

Chance per batch: ${pctPretty(perBatchChance)}
Avg batches: ~${isFinite(avgBatches) ? fmtInt(avgBatches) : "‚àû"}
Avg time: ~${timePretty(avgTime)}
`;

        if (el("wantShiny").value === "yes") {
          const perEggProbShiny = perEggProb / shinyMult; // approximate
          const shinyStats = calcBatchStats(perEggProbShiny);
          out +=
`\nShiny (√ó${shinyMult})
Shiny chance per batch: ${pctPretty(shinyStats.perBatchChance)}
Avg shiny batches: ~${isFinite(shinyStats.avgBatches) ? fmtInt(shinyStats.avgBatches) : "‚àû"}
Avg shiny time: ~${timePretty(shinyStats.avgTime)}
`;
        }

        el("singleOut").textContent = out;
        return;
      }

      // Odds pets: apply luck to denominator
      const effDen = p.value / luckMult;
      const perEggProb = 1 / effDen;
      const { perBatchChance, avgBatches, avgTime } = calcBatchStats(perEggProb);

      let out =
`${p.name} [${p.tier}]
Egg: ${p.egg}
Base Odds: 1/${fmtInt(p.value)}
Effective Odds: 1/${fmtInt(effDen)}

Chance per batch: ${pctPretty(perBatchChance)}
Avg batches: ~${isFinite(avgBatches) ? fmtInt(avgBatches) : "‚àû"}
Avg time: ~${timePretty(avgTime)}
`;

      if (el("wantShiny").value === "yes") {
        const effDenShiny = effDen * shinyMult;
        const perEggProbShiny = 1 / effDenShiny;
        const shinyStats = calcBatchStats(perEggProbShiny);
        out +=
`\nShiny (√ó${shinyMult})
Shiny Odds: 1/${fmtInt(effDenShiny)}
Shiny chance per batch: ${pctPretty(shinyStats.perBatchChance)}
Avg shiny batches: ~${isFinite(shinyStats.avgBatches) ? fmtInt(shinyStats.avgBatches) : "‚àû"}
Avg shiny time: ~${timePretty(shinyStats.avgTime)}
`;
      }

      el("singleOut").textContent = out;
    });

    el("copySingleBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(el("singleOut").textContent || "");
    });

    // ===== Egg breakdown (simplified output + Legendary+ default) =====
    el("renderEggBtn").addEventListener("click", () => {
      const luckMult = luckMultiplierFromPercent(el("luckPercent").value);
      const eggsPer = Math.max(1, Math.floor(Number(el("eggsPerCycle").value || 1)));
      const hatchTime = Number(el("hatchTimeSec").value);

      const egg = enabledEggs.find(e => e.name === eggSelect.value);
      if (!egg) { el("eggOut").textContent = "Select an egg."; return; }

      const filter = el("tierFilter").value || "Legendary+";
      const table = eggProbabilityTable(egg, luckMult);

      // Helper: chance per batch + avg batches for this pet probability
      const perBatchChance = (perEggProb) => 1 - Math.pow(1 - perEggProb, eggsPer);

      let lines = [];
      lines.push(`${egg.name} ‚Äî Cost: ${egg.cost.toLocaleString()} ${egg.currency}`);
      lines.push(`Luck: ${Number(el("luckPercent").value||0).toLocaleString()}% (${luckMult.toFixed(2)}√ó) ‚Ä¢ Eggs per batch: ${eggsPer} ‚Ä¢ Hatch time: ${hatchTime}s`);
      lines.push(`Showing: ${filter}`);
      lines.push("");

      const filtered = table.filter(p => passesTierFilter(p.tier, filter));

      if (filtered.length === 0) {
        lines.push("No pets match that filter.");
        el("eggOut").textContent = lines.join("\n");
        return;
      }

      filtered.forEach(p => {
        // Display odds clearly
        let oddsLine = "";
        let perEggProbForBatch = p.prob; // normalized prob used for per-batch chance in this egg table

        if (p.type === "percent") {
          oddsLine = `Odds: ${p.value}%`;
        } else {
          const effDen = p.value / luckMult;
          oddsLine = `Odds: 1/${fmtInt(effDen)} (effective)`;
        }

        const pb = perBatchChance(perEggProbForBatch);
        const avgB = pb > 0 ? (1 / pb) : Infinity;
        const avgT = avgB * hatchTime;

        lines.push(`${p.name}  [${p.tier}]`);
        lines.push(`  ${oddsLine}`);
        lines.push(`  Chance per batch: ${pctPretty(pb)}`);
        lines.push(`  Avg batches: ~${isFinite(avgB) ? fmtInt(avgB) : "‚àû"} ‚Ä¢ Avg time: ~${timePretty(avgT)}`);
        lines.push("");
      });

      el("eggOut").textContent = lines.join("\n").trim();
    });

    el("copyEggBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(el("eggOut").textContent || "");
    });

    // ===== Simulator (rename cycles->batches in output only) =====
    el("simBtn").addEventListener("click", () => {
      const luckMult = luckMultiplierFromPercent(el("luckPercent").value);
      const eggsPer = Math.max(1, Math.floor(Number(el("eggsPerCycle").value || 1)));
      const hatchTime = Number(el("hatchTimeSec").value);
      const shinyMult = Math.max(1, Number(el("shinyMult").value || 100));

      const egg = enabledEggs.find(e => e.name === simEggSelect.value);
      if (!egg) { el("simOut").textContent = "Select an egg."; return; }

      const batchesRequested = Math.max(1, Math.floor(Number(el("simCycles").value || 1)));
      const stopPet = el("simStopPet").value || "";
      const stopMode = el("simStopMode").value;

      const table = eggProbabilityTable(egg, luckMult);

      const counts = {};
      table.forEach(p => counts[p.name] = 0);

      let batchesDone = 0;
      let stopHit = false;
      let stopAtBatch = null;

      for (let c = 0; c < batchesRequested; c++){
        batchesDone++;
        for (let r = 0; r < eggsPer; r++){
          const pet = sampleFromTable(table);
          counts[pet.name]++;

          if (stopPet && pet.name === stopPet) {
            if (stopMode === "any") {
              stopHit = true;
              stopAtBatch = batchesDone;
              break;
            } else if (stopMode === "shiny") {
              const shinyChance = clamp((pet.prob / shinyMult), 0, 1); // simple v1
              if (Math.random() < shinyChance) {
                stopHit = true;
                stopAtBatch = batchesDone;
                break;
              }
            }
          }
        }
        if (stopHit) break;
      }

      const totalEggs = batchesDone * eggsPer;
      const totalTime = batchesDone * hatchTime;

      const lines = [];
      lines.push(`Simulation ‚Äî ${egg.name}`);
      lines.push(`Luck: ${Number(el("luckPercent").value||0).toLocaleString()}% (${luckMult.toFixed(2)}√ó)`);
      lines.push(`Eggs per batch: ${eggsPer} ‚Ä¢ Hatch time: ${hatchTime}s`);
      lines.push(`Batches simulated: ${batchesDone.toLocaleString()} (requested ${batchesRequested.toLocaleString()})`);
      lines.push(`Total eggs opened: ${totalEggs.toLocaleString()} ‚Ä¢ Simulated time: ${timePretty(totalTime)}`);
      if (stopPet) {
        lines.push(`Stop target: ${stopPet} (${stopMode === "shiny" ? "shiny" : "any"})`);
        lines.push(stopHit ? `‚úÖ Hit at batch ${stopAtBatch}` : `‚ùå Not hit`);
      }
      lines.push("");
      lines.push("Counts:");
      Object.entries(counts)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([name, ct]) => lines.push(`  ${name}: ${ct.toLocaleString()}`));

      el("simOut").textContent = lines.join("\n");
    });

    el("copySimBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(el("simOut").textContent || "");
    });
  });
})();
</script>
</body>
</html>
